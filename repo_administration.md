# Repo administration

This document describes the standard layout and organisation principles for
core tskit-dev projects. The GitHub workflows defined in this repo require
that this layout is followed.


## tskit-dev packages

The tskit dev managed packages can be split into two groups: Python only, and Python and C.
The rules for administration are slightly different for the two. The repos are:

**Python only**

- tszip
- tstrait
- tsbrowse
- pyslim

**Python and C**

- tskit
- msprime
- kastore
- tsinfer

## Releases

### Python packages

Releases are performed using the ``wheels.yml`` workflow in each repo using the
Trusted Publisher PyPI mechanism. Note that this mechanism requires that the
actual upload be performed from the source repository and not from a shared
workflow. There is therefore some duplication across the repos of this logic.

To make a release first test that the process is working by pushing to
a branch named ``test-publish``:

```
git fetch upstream
git checkout upstream/main
git checkout -b test-publish
git push upstream test-publish
```

Then go to the Actions tab on github and watch the progress of the build. If
it all succeeds a release should be pushed to testPyPI (click on the
"Publish Distribition to TestPyPI" section to get the URL at the end). If this looks OK, then
proceed with the release on the GitHub UI.

This action is only run on demand and not on push to main branch because
the binary wheel building is complex and expensive and there's little point in
running it over and over again. If it's broken when you get ready to do a
release, fix it.

For Python-only repos the workflow is very simple and does nothing that the
python-packaging tests don't do.

### Binary wheel building

This is done using the shared workflowA


### C API releases

DOCUMENT


## Dependency management

We use uv exclusively for Python package management. All Python dependencies must
be declared explicitly in pyproject.toml using dependency groups, which map to tasks
like running python tests or building documentation. The dependencies listed should
be minimal, and pinned only where necessary.

## Test coverage

Test coverage is monitored by CodeCov. When tests are run in CI, coverage is computed
and uploaded to CodeCov for each PR (and on merge). This is done using the
``CODECOV_TOKEN`` secret, which is generated by CodeCov and associated with a
given repo by GitHub. The token must be generated by logging in to the CodeCov UI,
copying the token and pasting it into the GitHub UI. This is in the settings/secrets
and variables/Actions section (repository secrets). It is important to check that
uploads are working correctly - do this by examining the GitHub actions logs and looking
at the output of the CodeCov upload command.

## Standard workflows

### Docs

All documentation is built using jupyterbook and is defined in the top-level "docs"
directory. The ``docs.yml`` workflow builds documentation and incorporates it
into the tskit.dev website. Two versions of the documentation are maintained,
"latest" and "stable". The latest version is updated from the repo each time
there is a merge. The stable version is updated on release.


### Lint

Linting is performed by prek, and the repo must define a prek.toml file at the
top level. The ``lint.yml`` workflow runs prek, and manages the installation
of other [FINISH ME - not clear how clang-format is fitting in here.].
The exact definition of the ruff linting rules is defined in pyproject.toml.

prek is intended to be run as a pre-commit hook. Run ``uv run prek install``
on the first time you use it. If you hit an obscure problem with gitlab
URLs, run ``uv run prek install -c prek.toml``.

If you are having problems with prek locally giving different results to
what's seen on CI, try running ``uv run prek cache clean``.


### Python C tests

If the project defines a low-level Python C module, there is a special

### C tests

If the project has a C library, it will define some unit tests in C
using C Unit. These are built using meson and ninja and coverage
uploaded to CodeCov.
